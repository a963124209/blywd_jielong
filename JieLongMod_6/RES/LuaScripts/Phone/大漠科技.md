# 大漠科技，震撼人心

## 大漠牌手机
手机有消息、联系人、朋友圈、我四个标签。

## 数据结构
```
PhoneDataBase = {
  profile = Profile,                    -- 当前玩家资料
  messages = MessagesDataBase,          -- 消息系统
  character = CharacterDataBase,        -- 联系人数据库
  settings = PhoneSettings,             -- 手机通用设置
  cache = PhoneCache,                   -- 临时缓存（最近图片、输入框内容等）
}

Profile = {
  nickname = string,
}

MessagesDataBase = {
  chatSessions = ChatSession[],      -- 所有会话
  unreadCount = number,
}

ChatSession = {
  id = string,                        -- 唯一ID（私聊可用双方UID组合）
  type = "private"|"group",           -- 会话类型
  name = string,                      -- 群名或对方昵称
  members = string[],                 -- 群成员UID
  messages = Message[],               -- 聊天记录
  unread = number,
  lastMessageTime = number,           -- 最后一条消息时间戳
  lastMessagePreview = string,        -- 聊天预览
}

Message = {
  id = string,
  sender = string,                    -- UID
  content = string,
  msgType = "text",
  timestamp = number,
}

CharacterDataBase = {
  characters = table<string, Character>,   -- UID映射
}

Character = {
  uid = string,
  name = string,
  moments = Moment[],
}

Moment = {
  id = string,
  author = string,
  content = string,
  timestamp = number,
  likes = string[],
  comments = Comment[],
}

Comment = {
  uid = string,
  content = string,
  time = number,
  replyTo = string|nil,
}

PhoneSettings = {

}
```
## 触发器
触发器的目的是在触发时，筛选符合条件的角色触发聊天或朋友圈事件。

```
PhoneTrigger = {
  id = string,
  type = "message|moment|reply",
  weight = integer,
  once = bool,
  require = function(info : TriggerInfo) : bool,
  event = async function(context : TriggerContext) : void,
}

TriggerInfo = {
  roleId = string,
  tagRole = RoleRuntimeData,
  player = RoleRuntimeData,

  tagCamp = CampRtData?,
  playerCamp = CampRtData?,

  curGameDay = number,
}

TriggerContext = {
  info = TriggerInfo,
  SendMessage = async function(msg : string, roleId : string),
  SendMoment = async function(moment : string),
}

```

触发器管理器是一个运行时添加的数据，保存在_G.triggerManager中，整体是不需要序列化的，每次打开游戏时会进行初始化。

方法包括：
1. 添加触发器
2. 进行触发器检测，需要传入触发类型
- 首先从CharacterManager中获取所有好友角色
- 每个角色触发一次事件的概率为 30%（暂定）
- 角色满足概率时，对符合类型的事件进行判断，满足的加入列表
- 列表里的事件，按照权重进行抽取
- 执行时，使用xlua+Unity协程方式包装事件，用 CS.WorldManager.Instance 作为 MonoBehaviour
1. 触发器特殊序列化部分：触发器会存储每个触发器触发过的次数，其中，once=true的事件，在判定时如果次数大于1，则不再触发。序列化部分参考IndexManager，存储一个table<string, integer>表，并在全局缓存。

## 触发器类型
daily_chat 每日对话触发器
friend_added 加好友时触发
reply 回复触发器，用于主角回复其他人触发

## 回复类型
1.打招呼
  - 问候
  - 关怀
  - 调情（好感度 > 50）
  - 挑衅
  - 训斥（同阵营且为首领）
2.送礼物
3.特殊对话

